<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">

    <title>Просто о сложном - Domain Driven Design</title>

    <meta name="description" content="Слайды к презентации о применении подхода Domain Driven Design">
    <meta name="author" content="Дмитрий Науменко">

    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="css/all.css">

    <script>
        document.write('<link rel="stylesheet" href="node_modules/reveal.js/css/print/' + ( window.location.search.match(/print-pdf/gi) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">');
    </script>
</head>

<body>
<div class="reveal">
    <div class="slides">
        <section class="title-slide">
            <h1>Domain Driven Design</h1>
            <h4>просто о сложном</h4>

            <br/>
            <br/>
            <p><a href="https://github.com/SilverFire">Дмитрий Науменко</a></p>
            <p>
                <small>
                    <a href="http://www.yiiframework.com/">Yii core team, </a><a href="http://hiqdev.com/">HiQDev</a>
                </small>
            </p>
        </section>

        <section>
            <h3>Disclaimer</h3>

            <ul>
                <li>Тема очень глубокая, я расскажу самые базовые вещи за 40 минут.</li>
                <li>Будет много кода.</li>
                <li>Многое упрощено для ясности.</li>
            </ul>
        </section>

        <section>
            <h3>План на сегодня</h3>

            <ul>
                <li>Узнать о понятии DDD</li>
                <li>Познакомиться с элементами DDD</li>
                <li>Итеративно отрефакторить приложение</li>
                <li>Рассмотреть преимущества и недостатки</li>
                <li>Сделать выводы</li>
            </ul>
        </section>

        <section>
            <h2>Сложность</h2>
            <h4>С какой сложностью мы чаще всего сталкиваемся?</h4>
        </section>

        <section>
            <h4>Сложность понимания &rarr; сложность поддержки</h4>
        </section>

        <section>
            <h3>Откуда берётся сложность?</h3>

            <ul>
                <li>Сложность реального мира</li>
                <li class="fragment" data-fragment-index="1">Гибкость программы</li>
                <li class="fragment" data-fragment-index="2">Проблема описания поведения системы</li>
                <li class="fragment" data-fragment-index="3">Работа над проектом с <u>изменяющимися требованиями</u></li>
            </ul>
        </section>

        <section>
            <h4>Как часто <u>изменяются требования</u>?</h4>

            <h2 class="fragment" data-fragment-index="1">
                <span class="fragment semi-fade-out" data-fragment-index="2">Часто</span>
            </h2>
            <h2 class="fragment fade-up" data-fragment-index="2">Постоянно</h2>
        </section>

        <section>
            <p>
                Было бы круто <span class="text-green">отображать</span> бизнес-процессы в архитектуре
                и <span class="text-green">реагировать</span> на это без существенного увеличения <b>сложности</b>.
            </p>
        </section>

        <section>
            <h3>DDD &ndash; Domain Driven Design</h3>

            <p>Набор подходов для организации кода в системах со сложной предметной областью</p>
        </section>

        <section>
            <h3>Ключевые концепции:</h3>

            <ul>
                <li>Domain</li>
                <li>Ubiquitous Language (Единый язык домена)</li>
                <li>Model-Driven Design (Проектирование по модели)</li>
                <li>
                    Шаблоны проектирования:
                    <ul style="margin: 0">
                        <li>Entity</li>
                        <li>Value Object</li>
                        <li>Aggregate Root</li>
                        <li>Repository</li>
                        <li>Service</li>
                    </ul>
                </li>
            </ul>
        </section>

        <section>
            <h3>Домен</h3>

            <p>Сущности и действия реального мира, которые нужно автоматизировать</p>
        </section>

        <section>
            <h3>Счёт на оплату</h3>
        </section>

        <section>
            <h3>Domain experts</h3>

            <ul>
                <li>Знают, как работает домен и его бизнес-процессы</li>
                <li class="fragment" data-fragment-index="1">Упускают "очевидные" детали</li>
                <li class="fragment" data-fragment-index="2">Ничего не знают о программировании и DDD</li>
            </ul>

            <small class="todo">картинка с экспертами</small>
        </section>

        <section>
            <p class="quote">Создаём счёт, добавляем в него товары и выставляем его клиенту.</p>
        </section>

        <section>
            <h3>Наши задачи:</h3>

            <ul>
                <li>Добыть знания о домене</li>
                <li>Выделить общие случаи из частных</li>
                <li>Понять, что из сказанного &mdash; туфта</li>
                <li class="fragment strike" data-fragment-index="1">Научить <b>их</b> изъясняться на <u>нашем</u> языке
                </li>
                <li class="fragment" data-fragment-index="1">Научиться изъясняться на <u>их</u> языке</li>
            </ul>
        </section>

        <section>
            <h2>Единый язык домена</h2>

            <p>Набор терминов, применяемых в модели домена для объяснения связей и действий</p>
        </section>

        <section>
            <h2>Зачем?</h2>

            <ul>
                <li>называть вещи своими именами</li>
                <li>общаться с доменными экспертами на одном языке</li>
            </ul>
        </section>

        <section>
            <p class="quote"><i>Создаём</i> <u>счёт</u>, <i>добавляем</i> в него <u>товары</u> и <i>выставляем</i> его
                <u>клиенту</u>.</p>

            <h3>Извлечение скрытого смысла</h3>

            <ul>
                <li>Какие есть характеристики счёта?</li>
                <li>Что может быть товаром?</li>
                <li>Какие характеристики товара важны?</li>
                <li>Что значит "выставить счёт"?</li>
                <li>Что мы знаем о клиенте?</li>
                <li>...</li>
            </ul>
        </section>

        <section>
            <img src="bill_product_client_0.png">
        </section>

        <section>
            <p class="todo">
                Картинка с блоками M V C
            </p>

            <ul>
                <li>Model</li>
                <li>Contoller</li>
                <li>View</li>
            </ul>
        </section>

        <section>
            <h3>Начнём по-простому</h3>

            <pre class="highlight php">
class BillController
{
    public function actionCreate($client_id, array $product_ids)
    {
        $client = Client::find()-&gt;byId($client_id)-&gt;one();
        if (!$client) { throw new NotFoundException(&apos;No client&apos;); }

        $bill = new Bill();
        $bill-&gt;client = $client;
        $bill-&gt;status = &apos;new&apos;;

        $products = Product::find()-&gt;byId($product_ids)-&gt;all();
        if (!$product) { throw new NotFoundException(&apos;No products&apos;); }

        $bill-&gt;items = $products;
        foreach ($bill-&gt;items as $item) {
            $bill-&gt;sum += $item-&gt;price;
        }
        $bill-&gt;save();
        $this-&gt;notifyBillCreated($client-&gt;email, $bill);
        $this-&gt;log-&gt;info(&apos;Created bill &apos; . $bill-&gt;id);

        return $this-&gt;render(&apos;bill&apos;, [&apos;bill&apos; =&gt; $bill]);
    }
}
</pre>
        </section>

        <section>
            <p class="quote">Само собой, товары в счёт можно добавлять и удалять, если счёт еще не выставлен</p>
        </section>

        <section>
                    <pre class="highlight php">
class BillController
{
    public function actionAddItem($bill_id, $item_id = null)
    {
        $bill = Bill::find()-&gt;byId($bill_id)-&gt;one();
        if (!$bill) { throw new NotFoundException(&apos;No bill&apos;); }
        if ($bill-&gt;status !== &apos;new&apos;) { throw new HttpException(403); }

        $product = Product::find()-&gt;byId($req-&gt;post(&apos;product_id&apos;))-&gt;one();
        if (!$product) { throw new NotFoundException(&apos;No product&apos;); }

        $bill-&gt;items[] = $product;
        $bill-&gt;calculateSum();

        $this-&gt;log-&gt;info(&apos;Updated bill &apos; . $bill-&gt;id);

        $bill-&gt;save();

        return $this-&gt;render(&apos;bill&apos;, [&apos;bill&apos; =&gt; $bill]);
    }
}
</pre>
        </section>

        <section>
            <h3>Ок :)</h3>

            <img src="i_v_prod.jpg" alt="">
        </section>

        <section>
            <h3>Преимущества:</h3>

            <ul>
                <li>Вся логика рядом, легко понять что происходит</li>
                <li>Нет ничего лишнего</li>
                <li>Низкий входной порог</li>
                <li>Легко дописать еще пару-тройку if-ов</li>
                <li class="fragment" data-fragment-index="1">Это &ndash; паттерн <a
                        href="https://martinfowler.com/eaaCatalog/transactionScript.html">Transaction script</a> :)
                </li>
            </ul>
        </section>

        <section>
            <h3>Недостатки:</h3>

            <ul>
                <li>Всё перемешано</li>
                <li>Сложно переиспользовать</li>
                <li>Тесты? Лолшто?</li>
                <li>Дописать еще пару if'ов и будет месиво</li>
            </ul>
        </section>

        <section>
            Может вынести логику из контроллера в модель <strong>Bill</strong>?
        </section>

        <section>
            <h3>Fat controller & Slim model</h3>
            <h4>VS</h4>
            <h3>Slim controller & Fat model</h3>
        </section>

        <section>
            <h3>Table Driven Domain model</h3>

            <ul>
                <li>Модель домена = модель данных</li>
                <li>Каждый объект модели представлен таблицей</li>
                <li>Объекты описывают связи БД</li>
            </ul>
        </section>

        <section>
            <h4>a.k.a</h4>
            <h2>ActiveRecord</h2>
        </section>

        <section>
            <h3>Плюсы:</h3>
            <ul>
                <li>Нужно минимум для старта</li>
                <li>Волшебно простой интерфейс</li>
                <li>Низкий порог вхождения</li>
                <li>Нет лишних преобразований</li>
                <li>Хорош для простого CRUD</li>
                <li>Легкая работа с relations</li>
            </ul>
        </section>

        <section>
            <h4>Минусы:</h4>
            <ul>
                <li>Жесткая связь с таблицей в БД</li>
                <li>Изменение таблицы &rarr; изменение кода</li>
                <li>Привязка типов данных к типам столбцов</li>
                <li>Сложность использования разных источников данных</li>
                <li>Нарушение Single Responsibility</li>
                <li>Больше логики &mdash; сложнее поддерживать</li>
            </ul>
        </section>

        <section>
            <h2>MVC</h2>
            <h3>M &ne; Модель ActiveRecord</h3>

            <h3>M &mdash; это целый Мир!</h3>
        </section>

        <section>
            <p class="todo">Картинка со слоями архитектуры</p>

            <ul>
                <li>Domain model</li>
                <li>Repository interfaces</li>
                <li>Domain services</li>
                <li>---</li>
                <li>Infrastructure</li>
                <li>Application</li>
            </ul>
        </section>

        <section>
            <h4>We need to go deeper</h4>

            <h3>Забудем на время о контроллерах</h3>
        </section>

        <section>
            <h2>Domain level</h2>

            <ul>
                <li>Entity</li>
                <li>Aggregate root</li>
                <li>Value Object</li>
            </ul>
        </section>

        <section>
            <h2>Entity</h2>

            <ul>
                <li>Описывает целостную сущность предметной области</li>
                <li>Определяется по идентификатору, а не по значению атрибутов</li>
                <li>Ничего не знает о БД или фреймворке</li>
            </ul>
        </section>

        <section>
            <img src="item_client.png" alt="">
        </section>

        <section>
            <pre class="highlight php">
class Client
{
    private $id;
    private $name;
    private $address;
    private $phone;

    public function __construct($id, $name, $address, $phone)
    {
        if (!preg_match(&apos;/\+\d+/&apos;, $phone)) {
            throw new ValidationException($phone);
        }
        $this-&gt;phone = $phone;

        // ... name, address
    }
}
</pre>
        </section>

        <section>
            <pre class="highlight php">
new Client(
    UUID::create(),
    &apos;Фамилия Имя Отчество&apos;,
    &apos;ул. Кодеров, д. 0xFF&apos;,
    &apos;+380441234567&apos;
);
</pre>
        </section>

        <section>
            <h4>Name, address, phone</h4>
            <ul>
                <li>Целостность</li>
                <li data-fragment-index="1" class="fragment">Валидация</li>
                <li data-fragment-index="2" class="fragment">Типизация</li>
            </ul>
        </section>

        <section>
            <h2>Value Object</h2>

            <ul>
                <li>Описывает характеристику или атрибут</li>
                <li>Типизирует в контексте домена</li>
                <li>Не обладает идентификатором</li>
                <li>Неизменяемый после создания</li>
            </ul>
        </section>

        <section>
            <img src="address.png"/>
        </section>

        <section>
            <pre class="highlight php">
class Address
{
    private $country;
    private $city;
    private $zip;
    private $lines;

    public function __construct($country, $city, $zip, $lines)
    {
        $this-&gt;country = $this-&gt;validateCountry($country);
        $this-&gt;city = $this-&gt;validateCity($city);
        $this-&gt;zip = $this-&gt;validatePhone($zip);
        $this-&gt;lines = $this-&gt;validateLines($lines);
    }

    private function validateZip($zip)
    {
        if (!preg_match(&apos;/^\d+$/&apos;, $zip) {
            throw new ZipValidationException($zip);
        }

        return $zip;
    }

    // ...
}
</pre>
        </section>

        <section>
            <img src="client_vo.png" alt="">
        </section>

        <section>
            <pre class="highlight php">
new Client(
    UUID::create(),
    new Name('Фамилия', 'Имя', 'Отчество'),
    new Address('Украина', 'Киев', '01001', ['ул. Кодеров, д. 0xFF']),
    new Phone('+380441234567')
);
</pre>
        </section>

        <section>
            <h3>Aggregate root</h3>

            <ul>
                <li>Собирательная сущность, считается единым целым</li>
                <li>Состоит из VO и Entity</li>
                <li>Определяется по идентификатору</li>
                <li>Рассматривается как единое целое при изменении данных</li>
                <li>Ничего не знает о БД или фреймворке</li>
                <li>В системе объекты ссылаются только на root</li>
            </ul>
        </section>

        <section>
            <img src="bill.png" alt="">
        </section>

        <section>
            <p class="quote">Каждого товара может быть больше чем 1 единица в счёте!</p>

            <h4>Уточним:</h4>
            <ul>
                <li>Меньше целой единицы можно?</li>
                <li>Валюта, правила округления и отображения цены?</li>
                <li>Единицы измерения &mdash; шт, метры, литры?</li>
            </ul>
        </section>

        <section>
            <img src="bill_w_vo.png" alt="">
        </section>

        <section>
            <pre class="highlight php">
class Item
{
    protected $id;
    protected $name;
    protected $description;
    protected $price;

    public function __construct($id, $name, Money $price) {
        $this-&gt;id = $id;
        $this-&gt;name = $name;
        $this-&gt;price = $price;
    }

    public function getId() {};

    public function getDescription() {};
    public function setDescription($description) {};

    public function getPrice() {};
    public function setPrice(Money $price) {};

    public function getName() {};
    public function setName() {};
}
</pre>
        </section>

        <section>
<pre class="highlight php">
$item = new Item(UUID::create(), &apos;Silver bullet&apos;, Money::USD(1000));
$item->setDescription('This bullet is a killing feature!');
</pre>
        </section>

        <section>
            <h3>Good practices</h3>

            <ul>
                <li>В конструкторе минимальный набор для целостности</li>
                <li>Интерфейсы для контроля типов и полиморфизма</li>
                <li>Закрыто всё, что не изменяется по логике домена</li>
            </ul>
        </section>

        <section>
        <pre class="highlight php">
class Position
{
    protected $item;
    protected $quantity;

    public function __construct(Item $item, $quantity = 1) {
        $this-&gt;item = $item;
        $this-&gt;quantity = $quantity;
    }

    public function getItem() {}

    public function getQuantity() {}
    public function setQuantity($quantity) {}

    public function getUnit() {}

    public function getPrice() {}
    public function getAmount() {}
}
</pre>
        </section>

        <section>
            <pre class="highlight php">
class Bill
{
    protected $id;
    protected $client;
    protected $positions;
    protected $status;

    public function __construct($id, Client $client)
    {
        $this-&gt;id = $id;
        $this-&gt;client = $client;
    }

    public function getId() {}
    public function getClient() {}

    public function getPositions() {}
    public function setPositions() {}

    public function getStatus() {}
    public function setStatus($status) {}
}      </pre>
        </section>

        <section>
<pre class="highlight php">
$item = new Item(UUID::create(), &apos;Silver bullet&apos;, Money::USD(1000));
$quantity = 2;

$bill = new Bill(UUID::create(), $client);
$bill->setStatus('new');
$bill->setPositions([new Position($item, $quantity)]);
</pre>

<pre class="highlight php fragment" data-fragment-index="1">
// Заменим позицию в счёте
$anotherPosition = new Position(
    new Item(UUID::create(), &apos;Rage cup&apos;, Money::USD(500))
);
$bill->setPositions([$anotherPosition]);
// save...
</pre>
        </section>

        <section>
            <pre class="highlight php">
$bill->setPositions([$anotherPosition]);
$bill->setStatus('processing');

// VS

$bill->positions = [$anotherPosition];
$bill->status = 'processing';
            </pre>
        </section>

        <section>
            <h1>???</h1>
        </section>

        <section>
            <h3>Анемия модели</h3>

            <ul>
                <li>Модель отображает связи</li>
                <li>В модели есть геттеры и сеттеры для свойств</li>
                <li>Модель не описывает действий и логики бизнеса</li>
            </ul>
        </section>

        <section>
            <pre class="highlight php">abstract class Status
{
    protected $name;
    protected $next = [];

    public function getName()
    {
        return $this-&gt;name;
    }

    public function canBeChangedTo(self $status)
    {
        return in_array(get_class($status), $this-&gt;next, true);
    }
}
            </pre>

            <pre class="highlight php">class NewStatus extends Status
{
    protected $name = 'new';

    protected $next = [
        ProcessingStatus::class,
        RejectedStatus::class
    ];
}
</pre>
        </section>

        <section>
            <pre class="highlight php">
class Bill
{
    public function changeStatus(Status $status) {
        if (!$this-&gt;status-&gt;canBeChangedTo($status)) {
            throw new WrongStatusChangeDirection();
        }

        $this-&gt;status = $status;
    }

    public function addPosition(Position $position) {
        if (!$this-&gt;status-&gt;allowsModification()) {
            throw new ModificationProhibitedException();
        }

        $this-&gt;positions-&gt;push($position);
    }

    public function removePosition(Position $position) {
        // ...
    }
}
            </pre>
        </section>

        <section>
            <pre class="highlight php">
$bill = new Bill(UUID::create(), $client);

$bill->addPosition(new Position($item, $quantity));
$bill->addPosition($anotherPosition);
$bill->changeStatus(new ProcessingStatus());
// save...
</pre>
        </section>

        <section>
            <h3>Как это всё связать с БД?</h3>
        </section>

        <section>
            <h3>ActiveRecord || DDD way?</h3>
        </section>

        <section>
            <h2>Repository</h2>

            <h3>Плюсы:</h3>
            <ul>
                <li>Является только интерфейсом хранилища</li>
                <li>Реализация не важна</li>
                <li>Типы полей не связаны</li>
                <li>Описывается интерфейсом</li>
                <li>Может использоваться с DI</li>
                <li>Может реализовывать разные хранилища</li>
                <li>Проще тестировать</li>
                <li>Хорошо ложится в DDD</li>
            </ul>
        </section>

        <section>
            <h2>Repository</h2>

            <h3>Минусы:</h3>
            <ul>
                <li>Сложно со старта</li>
                <li>Входной порог существенно выше</li>
                <li>Придётся писать гидраторы</li>
            </ul>
        </section>

        <section>
            <h3>Repository Interface Level</h3>

            <div class="todo">Картинка со слоями</div>

            <p>Описывает интерфейсы репозиториев и не содержит реализаций.</p>
        </section>

        <section>
<pre class="highlight php">
interface BillRepositoryInterface
{
    /** @throws BillNotFoundException when no bill exists */
    public function findById($id);
    public function findByStatus(Status $status);
    public function insert(Bill $bill);
    public function update(Bill $bill);
}
</pre>
        </section>

        <section>
            <h4>Реализация BillRepositoryInterface</h4>

            <ul>
                <li>Относится к инфраструктурному слою</li>
                <li>Описывает работу с хранилищем</li>
                <li>Реализацией может быть несколько</li>
            </ul>
        </section>

        <section>
            <pre class="highlight php">
class SqlBillRepository implements BillRepositoryInterface
{
    public function __construct(Connection $db) {
        $this-&gt;db = $db;
    }

    public function create(Bill $bill)
    {
        $this-&gt;db-&gt;transactionBegin();

        $this-&gt;db-&gt;insert(&apos;bill&apos;, [
            &apos;id&apos; =&gt; $bill-&gt;getId(),
            &apos;client_id&apos; =&gt; $bill-&gt;getClient()-&gt;getId(),
            &apos;status&apos; =&gt; $bill-&gt;getStatus()
        ]);

        foreach ($bill-&gt;getPositions() as $position) {
            $this-&gt;db-&gt;insert(&apos;bill_position&apos;, [
                &apos;item_id&apos; =&gt; $position-&gt;getItem()-&gt;getId(),
                &apos;quantity&apos; =&gt; $position-&gt;getQuantity(),
            ]);
        }

        $this-&gt;db-&gt;transactionCommit();

        return $bill-&gt;getId();
    }
}
</pre>
        </section>

        <section>
<pre class="highlight php">class BillController
{
    public function actionCreate($client_id, $positions = [])
    {
        $client = $this->clientRepository->findById($client_id);
        $bill = new Bill(UUID::create(), $client);
        $bill->changeStatus(new NewStatus());
        $this-&gt;billRepository-&gt;create($bill);

        $this->sendEmail(...);

        return $bill-&gt;getId();
    }
}</pre>
        </section>

        <section>
            <p class="todo">Картинка с перепрыгиванием через слои</p>
        </section>

        <section>
            <h4>Кроме того, есть и другие проблемы:</h4>

            <ul>
                <li>В контроллере всё еще много логики</li>
                <li>Что если будет несколько точек входа?</li>
                <li>Тесты?</li>
            </ul>
        </section>

        <section>
            <h3>Service Layer</h3>

            <ul>
                <li>В сервисы переезжает логика из контроллеров</li>
                <li>Предоставляет приложению интерфейсы для работы с доменом</li>
                <li>Сервисы содержат методы, описывающие действия домена</li>
                <li>Может обращаться к репозиториям и другим сервисам</li>
                <li>Не содержит состояния</li>
            </ul>
        </section>

        <section>
            <pre class="highlight php">
class BillService
{
    public function __construct(
        ClientRepositoryInterface $clientRepository,
        BillRepositoryInterface $billRepository
    ) {
        $this-&gt;clientRepository = $clientRepository;
        $this-&gt;billRepository = $billRepository;
    }

    public function create($clientId)
    {
        $client = $this-&gt;clientRepository-&gt;findById($clientId);

        $bill = new Bill(UUID::create(), $client);
        $bill-&gt;changeStatus(new NewStatus());

        $this-&gt;billRepository-&gt;create($bill);

        return $bill-&gt;getId();
    }
}
</pre>
        </section>

        <section>
            <h3>Что если метод сервиса получается сложный?</h3>
        </section>

        <section>
            <h4>Создавать более специализированные сервисы?</h4>

<pre class="highlight php">class BillPriceCalculationService
{
    public function calculate($bill)
    {
        // ...
    }

    private function applyDiscounts($bill)
    {
        // ...
    }

    private function calculatePositionsPrice($bill)
    {
        // ...
    }
}</pre>
        </section>

        <section>
            <h4>Или отдельные классы, которые хранят состояние</h4>

<pre class="highlight php">class BillPriceCalculator
{
    public function __construct(Bill $bill)
    {
        $this->bill = $bill;
    }

    public function calculate($bill)
    {
        // ...
    }

    private function applyDiscounts()
    {
        // ...
    }

    private function calculatePositionsPrice()
    {
        // ...
    }
}
</pre>
        </section>

        <section>
            <h3>Добавим немного проверок?</h3>

<pre class="highlight php">class BillService
{
    public function reject($billId)
    {
        if (($bill = $this-&gt;findById($id)) === null) {
            return null;
        }

        if ($bill-&gt;changeStatus(new ProcessingStatus()) === null) {
            return null;
        }

        if ($this-&gt;billRepository-&gt;update($bill) !== false) {
            // аккуратно, там ^^ в случае ошибки возвращается false!
            return null;
        }

        return true;
    }
}</pre>
        </section>

        <section>
            <h2>Exceptions</h2>

            <ul>
                <li>Метод либо выполняет работу, либо бросает исключение</li>
                <li>Не забывать предупреждать об исключениях в PHPDoc</li>
                <li>Название класса исключения максимально ясно описывает проблему</li>
            </ul>
        </section>

        <section>
<pre class="highlight php">class BillService
{
    function reject()
    {
        $bill = $this-&gt;billRepository-&gt;findById($id);
        $bill-&gt;changeStatus(new ProcessingStatus());

        $this-&gt;billRepository-&gt;update($bill);

        return true;
    }
}
</pre>
        </section>

        <section>
            <h3>Реакция на смену статуса &mdash; отправка письма</h3>
        </section>

        <section>
            <h4>Смена статуса как событие</h4>

            <pre class="highlight php">
class Bill
{
    public function registerEvent($event) { // TODO: можно вынести в trait
        $this-&gt;events[] = $event;
    }

    public function releaseEvents() {
        $events = $this-&gt;events;
        $this-&gt;events = [];

        return $events;
    }

    public function changeStatus(Status $status) {
        if (!$this-&gt;status-&gt;canBeChangedTo($status)) {
            throw new WrongStatusChangeDirection();
        }

        $this-&gt;status = $status;
        $this-&gt;registerEvent(
            new BillStatusWasChangedEvent($this-&gt;id, $status)
        );
    }
}
</pre>
        </section>

        <section>
<pre class="highlight php">class BillService
{
    public function reject($id)
    {
        $bill = $this-&gt;billRepository-&gt;findById($id);
        $bill-&gt;changeStatus(new ProcessingStatus());

        $this-&gt;billRepository-&gt;update($bill);

        $this->dispatcher->dispatchEvents($bill->releaseEvents());

        return true;
    }
}
</pre>
        </section>

        <section>
            <h3>Что если действие более сложное?</h3>
        </section>

        <section>
            <pre class="highlight php">class ClientService
{
    public function changeAddress($id, $country, $city, $zip, array $lines)
    {
        $address = new Address($country, $city, $zip, $lines);

        $client = $this-&gt;clientRepository-&gt;findById($id);
        $client-&gt;changeAddress($address);

        $this-&gt;clientRepository-&gt;update($client);

        return $client-&gt;getId();
    }
}</pre>
        </section>

        <section>
            <h3>Параметров уже многовато</h3>
            <h4>Что делать?</h4>

            <ul>
                <li class="fragment strike" data-fragment-index="1">Создавать Address в контролере</li>
                <li class="fragment strike" data-fragment-index="2">Передавать массив свойств</li>
                <li>Создать еще один класс</li>
            </ul>
        </section>

        <section>
            <h2>DTO</h2>
            <h3>Data Transfer Object</h3>
        </section>
        
        <section>
            <h3>Data Transfer Object</h3>

            <ul>
                <li>Для передачи данных между частями приложения</li>
                <li>Не содержит логики</li>
                <li>Типизирует набор данных</li>
            </ul>
        </section>

        <section>
        <pre class="highlight php">class AddressDto
{
    public $country;

    public $city;

    public $zip;

    public $lines = [];

    public function load($request)
    {
        // ...
    }
}
</pre>
        </section>

        <section>
            <pre class="highlight php">class ClientService
{
    public function changeAddress($id, AddressDto $dto)
    {
        $address = new Address(
            $dto-&gt;country,
            $dto-&gt;city,
            $dto-&gt;zip,
            $dto-&gt;lines
        );

        $client = $this-&gt;clientRepository-&gt;findById($id);
        $client-&gt;changeAddress($address);

        $this-&gt;clientRepository-&gt;update($client);

        return $client-&gt;getId();
    }
}</pre>
        </section>

        <section>
<pre class="highlight php">class ClientController
{
    public function actionChangeAddress($client_id)
    {
        $dto = (new AddressDto())-&gt;load($this-&gt;request);
        $this-&gt;clientRepository-&gt;changeAddress($client_id, $dto);

        return $client_id;
    }
}</pre>
        </section>

        <section>
            <h4>Что у нас получилось?</h4>

            <ul>
                <li>Приложение разделено на независимые слои</li>
                <li>Нет завязанности на БД, фреймворке</li>
                <li>Код более выразительный</li>
                <li>Чистое ООП</li>
                <li>Каждый слой легко тестируется</li>
            </ul>
        </section>

        <section>
            <h3>Всё ли так хорошо?</h3>
        </section>

        <section>
            <p class="todo">Кривая сложности</p>
        </section>

        <section>
            <h3>Конечно, есть и проблемы</h3>

            <ul>
                <li>Сrosscutting concerns</li>
                <li>Переабстрагирование</li>
                <li>Сложно понять</li>
                <li>Работа с данными описана сложнее</li>
                <li>Есть много нюансов реализации</li>
                <li>Оверхед для простой бизнес-логики</li>
                <li>Сложно натянуть на "бедную" процессами модель</li>
            </ul>
        </section>

        <section>
            <h4>DDD на 90% проектов &mdash; оверхед, который не стоит потраченных усилий</h4>

            <h3 class="fragment" data-fragment-index="1">Но это не повод не учиться.</h3>
        </section>

        <section>
            <h4>Think first. DDD &mdash; это рекомендации, а не правила.</h4>
        </section>

        <section>
            <h4>Идеи из DDD можно использовать и c ActiveRecord</h4>

            <ul>
                <li>Entity, Aggregate root &mdash; модель ActiveRecord с ясными методами</li>
                <li>DTO &mdash; формы</li>
                <li>Services &mdash; уносят сложность из контроллеров и моделей</li>
                <li>Repository &mdash; можно заменить ActiveQuery с методами, которые ясно описыают условия</li>
            </ul>
        </section>

        <section>
            <h4>Начните с малого. И еще раз think first.</h4>
        </section>

        <section>
            <h3>Почитать</h3>

            <ul>
                <li>https://www.amazon.com/Domain-Driven-Design-Tackling-Complexity-Software-ebook/dp/B00794TAUG</li>
                <li>https://github.com/PhpFriendsOfDdd</li>
                <li>https://lostechies.com/jamesgregory/2009/05/09/entity-interface-anti-pattern</li>
            </ul>
        </section>
    </div>
</div>

<script src="js/all.js"></script>

<script>
    // Full list of configuration options available here:
    // https://github.com/hakimel/reveal.js#configuration
    Reveal.initialize({
        controls: false,
        progress: true,
        history: true,
        center: true,
        margin: 0.1,
        slideNumber: true,

        theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
        transition: Reveal.getQueryHash().transition || 'none', // default/cube/page/concave/zoom/linear/fade/none

        // Optional libraries used to extend on reveal.js
        dependencies: [
            {
                src: 'js/reveal/highlight/highlight.js',
                async: true,
                callback: function () {
                    [].forEach.call(document.querySelectorAll('.highlight, code'), function (v, i) {
                        hljs.highlightBlock(v);
                    });
                }
            },
            {src: 'js/reveal/notes/notes.js', async: true}
        ]
    });
</script>
<script type="text/javascript"> (function (d, w, c) {
    (w[c] = w[c] || []).push(function () {
        try {
            w.yaCounter37501675 = new Ya.Metrika({
                id: 37501675,
                clickmap: true,
                trackLinks: true,
                accurateTrackBounce: true
            });
        } catch (e) {
        }
    });
    var n = d.getElementsByTagName("script")[0], s = d.createElement("script"), f = function () {
        n.parentNode.insertBefore(s, n);
    };
    s.type = "text/javascript";
    s.async = true;
    s.src = "https://mc.yandex.ru/metrika/watch.js";
    if (w.opera == "[object Opera]") {
        d.addEventListener("DOMContentLoaded", f, false);
    } else {
        f();
    }
})(document, window, "yandex_metrika_callbacks"); </script>
<noscript>
    <div><img src="https://mc.yandex.ru/watch/37501675" style="position:absolute; left:-9999px;" alt=""/></div>
</noscript>
</body>
</html>
