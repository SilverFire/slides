<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">

        <title>Просто о сложном - Domain Driven Design</title>

        <meta name="description" content="Слайды к презентации о применении подхода Domain Driven Design">
        <meta name="author" content="Дмитрий Науменко">

        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

        <link rel="stylesheet" href="css/all.css">

        <script>
            document.write( '<link rel="stylesheet" href="node_modules/reveal.js/css/print/' + ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">' );
        </script>
    </head>

    <body>
        <div class="reveal">
            <div class="slides">
                <section class="title-slide">
                    <h1>Domain Driven Design</h1>
                    <h4>просто о сложном</h4>

                    <br />
                    <br />
                    <p><a href="https://github.com/SilverFire">Дмитрий Науменко</a></p>
                    <p>
                        <small>
                            <a href="http://www.yiiframework.com/">Yii core team, </a><a href="http://hiqdev.com/">HiQDev</a>
                        </small>
                    </p>
                </section>

                <section>
                    <h3>Disclaimer</h3>

                    <ul>
                        <li>Тем очень глубокая, за 40 минут ее не осилить.</li>
                        <li>Будет много кода.</li>
                        <li>...</li>
                    </ul>
                </section>

                <section>
                    <h3>План на сегодня</h3>

                    <ul>
                        <li>Узнать понятии DDD и его элементах</li>
                        <li>Познакомиться с элементами DDD</li>
                        <li>Итеративно отрефакторить приложение</li>
                        <li>Рассмотреть преимущества и недостатки</li>
                        <li>Сделать выводы</li>
                    </ul>
                </section>

                <section>
                    <h2>Сложность</h2>
                    <h4>С какой сложностью мы чаще всего сталкиваемся?</h4>
                </section>

                <section>
                    <h4>Сложность понимания &rarr; сложность поддержки</h4>
                </section>

                <section>
                    <h3>Откуда берётся сложность?</h3>

                    <ul>
                        <li>Сложность реального мира</li>
                        <li class="fragment" data-fragment-index="1">Гибкость программы</li>
                        <li class="fragment" data-fragment-index="2">Проблема описания поведения системы</li>
                        <li class="fragment" data-fragment-index="3">CI с <u>изменяющимися требованиями</u></li>
                    </ul>
                </section>

                <section>
                    <h4>Как часто <u>изменяются требования</u>?</h4>

                    <h2 class="fragment" data-fragment-index="1">
                        <span class="fragment semi-fade-out" data-fragment-index="2">Часто</span>
                    </h2>
                    <h2 class="fragment fade-up" data-fragment-index="2">Постоянно</h2>
                </section>

                <section>
                    <p>
                        Было бы круто <span class="text-green">отображать</span> бизнес-процессы в архитектуре
                        и <span class="text-green">реагировать</span> на это без увеличения <b>сложности</b>.
                    </p>
                </section>

                <section>
                    <h3>DDD &ndash; Domain Driven Design</h3>

                    <h5>Набор подходов для борьбы со сложностью в приложениях.</h5>
                </section>

                <section>
                    <h3>Ключевые концепции:</h3>

                    <ul>
                        <li>Domain</li>
                        <li>Ubiquitous Language (Единый язык домена)</li>
                        <li>Model-Driven Design (Проектирование по модели)</li>
                        <li>
                            Шаблоны проектирования:
                            <ul style="margin: 0">
                                <li>Entity</li>
                                <li>Value Object</li>
                                <li>Aggregate Root</li>
                                <li>Repository</li>
                                <li>Service</li>
                            </ul>
                        </li>
                    </ul>
                </section>

                <section>
                    <h3>Домен</h3>

                    <p>Предметная область знаний, связей и действий, для которой создается программное обеспечение.</p>
                </section>

                <section>
                    <h3>Счёт на оплату</h3>
                </section>

                <section>
                    <h3>Domain experts</h3>

                    <ul>
                        <li>Знают, как работает домен и его бизнес-процессы</li>
                        <li class="fragment" data-fragment-index="1">Упускают "очевидные" детали</li>
                        <li class="fragment" data-fragment-index="2">Не знают ничего программировании и DDD</li>
                    </ul>

                    <small class="todo">картинка с экспертами</small>
                </section>

                <section>
                    <p class="quote">Создаём счёт, добавляем в него товары и выставляем его клиенту.</p>
                </section>

                <section>
                    <h3>Наши задачи:</h3>

                    <ul>
                        <li>Добыть знания о домене</li>
                        <li>Выделить общие случаи из частных</li>
                        <li>Понять, что из сказанного &mdash; туфта</li>
                        <li class="fragment strike" data-fragment-index="1">Научить <b>их</b> изъясняться на <u>нашем</u> языке</li>
                        <li class="fragment" data-fragment-index="1"><span class="fragment strike" data-fragment-index="2">Научиться изъясняться на <u>их</u> языке</span></li>
                        <li class="fragment" data-fragment-index="2">Выработать <b>понятный</b> для обоих сторон язык!</li>
                    </ul>
                </section>

                <section>
                    <h2>Единый язык домена</h2>

                    <p>Набор терминов, применяемых в модели домена для объяснения связей и действий</p>
                </section>

                <section>
                    <h2>Зачем?</h2>

                    <ul>
                        <li>называть вещи своими именами</li>
                        <li>общаться с доменными экспертами на одном языке</li>
                    </ul>
                </section>

                <section>
                    <p class="quote"><i>Создаём</i> <u>счёт</u>, <i>добавляем</i> в него <u>товары</u> и <i>выставляем</i> его <u>клиенту</u>.</p>

                    <h3>Извлечение скрытого смысла</h3>

                    <ul>
                        <li>Какие есть характеристики счёта?</li>
                        <li>Что может быть товаром?</li>
                        <li>Какие характеристики товара важны?</li>
                        <li>Что значит "выставить счёт"?</li>
                        <li>Что мы знаем о клиенте?</li>
                        <li>...</li>
                    </ul>
                </section>

                <section>
                    <img src="bill_product_client_0.png">
                </section>

                <section>
                    <p class="todo">
                        Картинка с блоками M V C
                    </p>

                    <ul>
                        <li>Model</li>
                        <li>Contoller</li>
                        <li>View</li>
                    </ul>
                </section>

                <section>
                    <h3>Начнём по-простому</h3>

                    <pre class="highlight php">
class BillController
{
    public function actionCreateBill($client_id, array $product_ids)
    {
        $client = Client::find()-&gt;byId($client_id)-&gt;one();
        if (!$client) { throw new NotFoundException(&apos;No client&apos;); }

        $bill = new Bill();
        $bill-&gt;client = $client;
        $bill-&gt;status = &apos;new&apos;;

        $products = Product::find()-&gt;byId($product_ids)-&gt;all();
        if (!$product) { throw new NotFoundException(&apos;No products&apos;); }

        $bill-&gt;items = $products;
        foreach ($bill-&gt;items as $item) {
            $bill-&gt;sum += $item-&gt;price;
        }
        $bill-&gt;save();
        $this-&gt;notifyBillCreated($client-&gt;email, $bill);
        $this-&gt;log-&gt;info(&apos;Created bill &apos; . $bill-&gt;id);

        return $this-&gt;render(&apos;bill&apos;, [&apos;bill&apos; =&gt; $bill]);
    }
}
</pre>
                </section>

                <section>
                    <p class="quote">Само собой, товары в счёт можно добавлять и удалять, если счёт еще не выставлен</p>
                </section>

                <section>
                    <pre class="highlight php">
class BillController
{
    public function actionAddItem($bill_id, $item_id = null)
    {
        $bill = Bill::find()-&gt;byId($bill_id)-&gt;one();
        if (!$bill) { throw new NotFoundException(&apos;No bill&apos;); }
        if ($bill-&gt;status !== &apos;new&apos;) { throw new HttpException(403); }

        $product = Product::find()-&gt;byId($req-&gt;post(&apos;product_id&apos;))-&gt;one();
        if (!$product) { throw new NotFoundException(&apos;No product&apos;); }

        $bill-&gt;items[] = $product;
        $bill-&gt;calculateSum();

        $this-&gt;log-&gt;info(&apos;Updated bill &apos; . $bill-&gt;id);

        $bill-&gt;save();

        return $this-&gt;render(&apos;bill&apos;, [&apos;bill&apos; =&gt; $bill]);
    }
}
</pre>
                </section>

                <section>
                    <h3>Ок :)</h3>

                    <img src="i_v_prod.jpg" alt="">
                </section>

                <section>
                    <h3>Преимущества:</h3>

                    <ul>
                        <li>Вся логика рядом, легко понять что происходит</li>
                        <li>Нет ничего лишнего</li>
                        <li>Низкий входной порог</li>
                        <li>Легко дописать еще пару-тройку if-ов</li>
                    </ul>
                </section>

                <section>
                    <h3>Недостатки:</h3>

                    <ul>
                        <li>Всё перемешано</li>
                        <li>Сложно переиспользовать</li>
                        <li>Тесты? Лолшто?</li>
                        <li>Дописать еще пару if'ов и будет месиво</li>
                        <li>ActiveRecord</li>
                        <li>Это не DDD</li>
                    </ul>
                </section>

                <section>
                    Может вынести логику из контроллера в модель <strong>Bill</strong>?
                </section>

                <section>
                    <h3>Fat controller & Slim model</h3>
                    <h4>VS</h4>
                    <h3>Slim controller & Fat model</h3>
                </section>

                <section>
                    <p class="quote">Каждого товара может быть больше чем 1 единица в счёте!</p>

                    <h4>Уточним:</h4>
                    <ul>
                        <li>Единицы измерения &mdash; шт, метры, литры?</li>
                        <li>Меньше целой единицы можно?</li>
                        <li>Валюта, правила округления?</li>
                    </ul>
                </section>

                <section>
                    <h2>MVC</h2>
                    <h3>M &ne; Модель ActiveRecord</h3>

                    <h3>M &mdash; это целый Мир!</h3>
                </section>

                <section>
                    <p class="todo">Картинка со слоями архитектуры</p>

                    <ul>
                        <li>Domain model</li>
                        <li>Repository interfaces</li>
                        <li>Domain services</li>
                        <li>Infrastructure</li>
                        <li>Application</li>
                    </ul>
                </section>

                <section>
                    <h2>Domain level</h2>
                </section>

                <section>
                    <h2>Entity</h2>

                    <ul>
                        <li>Описывает целостную сущность предметной области</li>
                        <li>Определяется по идентификатору, а не по значению атрибутов</li>
                    </ul>
                </section>

                <section>
                    <img src="item_client.png" alt="">
                </section>

                <section>
                    <h4>Name, address, phone</h4>
                    <ul>
                        <li>Целостность</li>
                        <li data-fragment-index="1" class="fragment">Валидация</li>
                        <li data-fragment-index="2" class="fragment">Типизация</li>
                    </ul>
                </section>

                <section>
                    <h2>Value Object</h2>

                    <ul>
                        <li>Описывает характеристику или атрибут</li>
                        <li>Типизирует в контексте домена</li>
                        <li>Не обладает идентичностью</li>
                        <li>Неизменяемый после создания</li>
                    </ul>
                </section>

                <section>
                    <img src="address.png" />
                </section>

                <section>
                    <img src="client_vo.png" alt="">
                </section>

                <section>
                    <h3>Aggregation root</h3>

                    <ul>
                        <li>Собирательная сущность, считаетсы единым целым</li>
                        <li>Состоит из VO и Entity</li>
                        <li>Определяется по идентификатору</li>
                    </ul>
                </section>

                <section>
                    <img src="bill.png" alt="">
                </section>

                <section>
                    <img src="bill_w_vo.png" alt="">
                </section>

                <section>
                    <h3>А как это всё связать с БД?</h3>
                </section>

                <section>
                    <h2>ActiveRecord</h2>

                    <h3>Плюсы:</h3>
                    <ul>
                        <li>Нужно минимум для старта</li>
                        <li>Низкий порог вхождения</li>
                        <li>Хорош для простого CRUD</li>
                        <li>Нет лишних преобразований</li>
                    </ul>
                </section>

                <section>
                    <h2>ActiveRecord</h2>

                    <h4>Минусы:</h4>
                    <ul>
                        <li>Жесткая связь с таблицей в БД</li>
                        <li>Привязка типов данных к типам столбцов</li>
                        <li>Сложность использования разных источников данных</li>
                        <li>Изменение таблицы &rarr; изменение кода</li>
                        <li>Нарушение Single Responsibility</li>
                        <li>Больше логики &mdash; сложнее поддерживать</li>
                        <li>Не для DDD</li>
                    </ul>
                </section>

                <section>
                    <h3>Repository</h3>

                    <h3>Плюсы:</h3>
                    <ul>
                        <li>Описывается интерфейсами &rarr; реализация не важна &rarr; домен отделён от хранилища</li>
                        <li>Проще тестировать</li>
                        <li>Типы полей не связаны</li>
                        <li>Хорошо ложится в DDD</li>
                    </ul>
                </section>

                <section>
                    <pre class="highlight php">
class ProductRepository
{
    public function findById($id)
    {
        // PDO, API, whatever
        return $product;
    }

    public function save($product)
    {

    }
}
</pre>
                </section>

                <section>
                    <pre class="highlight php">
class BillController
{
    public function actionAddItem()
    {
        $req = $this-&gt;request;
        $bill = $this-&gt;billRepository-&gt;findById($req-&gt;post(&apos;id&apos;));
        if (!$bill) { throw new NotFoundException(&apos;No bill&apos;); }
        if ($bill-&gt;status !== &apos;new&apos;) { throw new HttpException(403); }

        $product = $this-&gt;productRepository-&gt;findById($req-&gt;post(&apos;product_id&apos;));
        if (!$product) { throw new NotFoundException(&apos;No product&apos;); }

        $bill-&gt;items[] = $product;
        $bill-&gt;calculateSum();

        if ($bill-&gt;client) {
            $this-&gt;sendUpdatedBill($bill-&gt;client-&gt;email, $bill);
        }

        $bill-&gt;save();

        return $this-&gt;render(&apos;bill&apos;, [&apos;bill&apos; =&gt; $bill]);
    }
}</pre>

                </section>

                <section>
// Агрегат состоит и из VO, не имеющих id, и из Entity, имеющих id. Агрегат состоит из объектов. Агрегат не содержит Id вместо сущностей.
// ddd не используются тупые сеттеры. Методы должны быть названы более человекопонятно - rename например, changePassword, activize
// репозиторий - это не сервис. Домен состоит из трех частей - модели (сущности и value objects), сервисы домена, репозитории.
// ddd красиво ложится на богатую бизнес-процессами модель, а на crud ложится тяжко, как мы видим
                    <img src="order-item.png" alt="">
                </section>

                <section>
                    <h3>Проектирование по модели</h3>

                    <p class="todo"></p>
                </section>

                <section>
                    <p class="todo">Кривая сложности</p>
                </section>

                <section>
                    <h3>И всё прям так хорошо?</h3>
                </section>

                <section>
                    <h3>Конечно, есть и проблемы</h3>

                    <ul>
                        <li>crosscutting concerns</li>
                        <li>переабстрагирование</li>
                        <li class="todo"></li>
                    </ul>
                </section>

                <section>
                    <h4>А без DDD этих проблем нет, ведь так?</h4>
                </section>

                <section>
                    <p class="todo">Про процедурную бизнес-логику с примерами, преимуществами и недостатками</p>
                </section>

                <section>
                    <h4>Как это собрать воедино?</h4>

                    <p class="todo"></p>
                </section>

                <section>
                    <ul>
                        <li>Я рассказал про абстрактного коня в вакууме</li>
                        <li>Think first. DDD &mdash; даёт рекомендации, а не правила</li>
                        <li>Начните с малого</li>
                    </ul>
                </section>

                <section>
                    <h3>Почитать</h3>

                    <ul>
                        <li>https://www.amazon.com/Domain-Driven-Design-Tackling-Complexity-Software-ebook/dp/B00794TAUG</li>
                        <li>https://github.com/PhpFriendsOfDdd</li>
                    </ul>
                </section>
            </div>
        </div>

        <script src="js/all.js"></script>

        <script>
            // Full list of configuration options available here:
            // https://github.com/hakimel/reveal.js#configuration
            Reveal.initialize({
                controls: false,
                progress: true,
                history: true,
                center: true,
                margin: 0.1,
                slideNumber: true,

                theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
                transition: Reveal.getQueryHash().transition || 'none', // default/cube/page/concave/zoom/linear/fade/none

                // Optional libraries used to extend on reveal.js
                dependencies: [
                    {
                        src: 'js/reveal/highlight/highlight.js',
                        async: true,
                        callback: function () {
                            [].forEach.call(document.querySelectorAll('.highlight, code'), function (v, i) {
                                hljs.highlightBlock(v);
                            });
                        }
                    },
                    { src: 'js/reveal/notes/notes.js', async: true}
                ]
            });
        </script>
    <script type="text/javascript"> (function (d, w, c) { (w[c] = w[c] || []).push(function() { try { w.yaCounter37501675 = new Ya.Metrika({ id:37501675, clickmap:true, trackLinks:true, accurateTrackBounce:true }); } catch(e) { } }); var n = d.getElementsByTagName("script")[0], s = d.createElement("script"), f = function () { n.parentNode.insertBefore(s, n); }; s.type = "text/javascript"; s.async = true; s.src = "https://mc.yandex.ru/metrika/watch.js"; if (w.opera == "[object Opera]") { d.addEventListener("DOMContentLoaded", f, false); } else { f(); } })(document, window, "yandex_metrika_callbacks"); </script> <noscript><div><img src="https://mc.yandex.ru/watch/37501675" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
    </body>
</html>
